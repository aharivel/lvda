FROM nginx:alpine

# Install git and curl for cloning and health checks
RUN apk add --no-cache git curl

# Create directory structure
RUN mkdir -p /usr/share/nginx/html/admin /var/run/nginx

# Clone the repository directly to get exact file state
WORKDIR /tmp
RUN git clone --branch feature/claude-improvements https://github.com/aharivel/lvda.git repo

# Set working directory to the cloned repository root (contains website files)
WORKDIR /tmp/repo


# Copy nginx configuration from the cloned repo
RUN cp nginx-unified.conf /etc/nginx/nginx.conf

# Copy main website files from cloned repo
RUN cp *.html /usr/share/nginx/html/ && \
    cp -r css/ /usr/share/nginx/html/ && \
    cp -r js/ /usr/share/nginx/html/ && \
    cp -r img/ /usr/share/nginx/html/ && \
    cp -r vendor/ /usr/share/nginx/html/

# Debug: Check what carousel images are actually present
RUN echo "=== CAROUSEL IMAGE DEBUG ===" && \
    ls -la /usr/share/nginx/html/img/balade* || echo "No balade images found" && \
    ls -la /usr/share/nginx/html/img/pension* || echo "No pension images found" && \
    ls -la /usr/share/nginx/html/img/diapo* || echo "No diapo images found" && \
    echo "=== END DEBUG ==="

# Copy admin panel files from cloned repo
RUN cp -r admin/public/ /usr/share/nginx/html/admin/

# Clean up git repository to reduce image size
RUN rm -rf /tmp/repo

# Create basic auth file for admin (username: admin, password: admin123)
# In production, use a stronger password and proper secret management
RUN apk add --no-cache apache2-utils && \
    htpasswd -cb /etc/nginx/.htpasswd admin admin123

# Set proper permissions
RUN chown -R nginx:nginx /usr/share/nginx/html

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/ || exit 1

EXPOSE 3000

# Start nginx
CMD ["nginx", "-g", "daemon off;"]