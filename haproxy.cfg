# HAProxy configuration for LVDA HA architecture
# Routing VM: HAProxy + Cloudflare tunnel

global
    daemon
    maxconn 4096
    log stdout local0
    
    # Stats socket for management
    stats socket /var/run/haproxy.sock mode 660 level admin

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout http-request 10s
    timeout http-keep-alive 2s
    timeout check 10s
    
    # Logging
    option httplog
    log global
    
    # Health checks
    option httpchk GET /
    
    # Better error pages
    errorfile 503 /etc/haproxy/errors/503.http

frontend lvda_frontend
    bind *:80
    
    # Security headers
    http-response set-header X-Frame-Options DENY
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    
    # Routing rules
    acl is_api path_beg /api
    acl is_health path /health
    
    # Route API calls to backend
    use_backend lvda_api if is_api
    
    # Route health checks
    use_backend haproxy_health if is_health
    
    # Default: route to frontend servers
    default_backend lvda_frontend

backend lvda_frontend
    # Frontend web servers (HA/failover)
    balance roundrobin
    
    # Primary server (main production server)
    server primary 192.168.1.74:8080 check inter 10s fall 3 rise 2
    
    # Backup server (bootc VM or additional server)  
    server backup 192.168.1.75:8080 check inter 10s fall 3 rise 2 backup
    
    # Health check configuration
    http-check expect status 200

backend lvda_api
    # Backend API server (centralized)
    balance roundrobin
    
    # API server on same router VM (localhost)
    server api 127.0.0.1:3000 check inter 5s fall 2 rise 2
    
    # Health check for API
    http-check expect status 200
    
    # Remove /api prefix when forwarding to backend
    http-request replace-path /api/(.*) /api/\1

backend haproxy_health
    # Simple health check endpoint
    http-request return status 200 content-type text/plain string "HAProxy OK"

# Statistics and monitoring
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    
    # Basic auth for stats (optional)
    # stats auth admin:your-password-here